<!DOCTYPE html>
<html>
    <head>
        <title>DataDoo : Three.js activity on Github</title>
        <style>
            body {
                background: #fff;
                padding: 0;
                margin: 0;
                overflow: hidden;
                font-family: "Lucida Console", "Lucida Sans Typewriter", Monaco, "Bitstream Vera Sans Mono", monospace;
                text-align: center;
            }

            .datadoo-label {
                background: rgba(220, 220, 220, 0.5);
                font-size: 0.7em;
            }

            .datadoo-wrap {

            }
        </style>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <script src="../build/vendor.js"></script>
        <script src="../build/datadoo.js"></script>

        <script type="text/javascript">
            var dd = new DataDoo({
                canvas: document.getElementById("canvas"),
                camera: {
                    type: DataDoo.PERSPECTIVE
                },
                axes: {
                    x: {
                        type: DataDoo.COLUMNVALUE,
                        column : "dsMiso.week",
                        label : "week#",
                        length : 500,
                        withCone: false,
                        notches : true,
                        notchSpacing : 10
                    },

                    y: {
                        type: DataDoo.COLUMNVALUE,
                        column : "dsMiso.commitCount",
                        label : "count#",
                        withCone: true,
                        length : 500,
                        notches : true,
                        notchSpacing : 25
                    },

                    z: {
                        type: DataDoo.COLUMNVALUE,
                        column : "dsMiso.dayName",
                        label : "dayname",
                        length : 350,
                        withCone: true,
                        notches : true,
                        notchSpacing : 20
                    }
                }
            });

            var GH = {};
            GH.CommitsParser = function (options) {};
            _.extend(GH.CommitsParser.prototype, Miso.Dataset.Parsers.prototype, {
                parse : function (data) {
                    var columns = ['week', 'dayName', 'dayNumber', 'commitCount'];
                    var dataColumns = { week : [], dayName : [], dayNumber : [], commitCount : [] };

                    _.each(data, function (c) {
                        var d = moment(c.commit.committer.date);
                        var week = d.week();
                        var dayName = d.format("dddd");
                        var dayNumber = d.dayOfYear();

                        //Find if an entry for this commit exists already by checking the dayNumber array
                        var indx = _.indexOf(dataColumns.dayNumber, dayNumber);

                        if(indx!==-1){
                            dataColumns.commitCount[indx]++;
                        }
                        else{
                            dataColumns.week.push(week);
                            dataColumns.dayName.push(dayName);
                            dataColumns.dayNumber.push(dayNumber);
                            dataColumns.commitCount.push(1);
                        }
                    });

                    return {
                        columns : columns,
                        data : dataColumns
                    };
                }
            });

            var misoConfig = {
                url : 'https://api.github.com/repos/misoproject/dataset/commits?per_page=100&callback=',
                jsonp : true,
                extract : function(response) {
                    return response.data;
                },
                parser : GH.CommitsParser,
                sync:true
            };

            var threeConfig = {
                url : 'https://api.github.com/repos/mrdoob/three.js/commits?per_page=100&callback=',
                jsonp : true,
                extract : function(response) {
                    return response.data;
                },
                parser : GH.CommitsParser,
                sync:true
            };

            var dsMiso = new DataDoo.DataSet(dd, "dsMiso", misoConfig);
            var dsThree = new DataDoo.DataSet(dd, "dsThree", threeConfig);

            var nodeFnMiso = function($) {
                this.sphere = this.addSphere(this.data.commitCount, 0xffaa00, 0.7);
                this.position.setOnAxes(this.data.week, this.data.commitCount, this.data.dayName);
            };

            var nodeFnThree = function($) {
                this.sphere = this.addSphere(this.data.commitCount, 0xff0000, 1);
                this.position.setOnAxes(this.data.week, this.data.commitCount, this.data.dayName);
            };

            var relFn = function($) {
                var r = this.addRelation();
                r.addSpline($.ngMiso, "0xffcc00", 12);
                //r.addSpline($.ngThree, "0xfc1234", 12);
            };

            var ngMiso = new DataDoo.NodeGenerator(dd, "ngMiso", dsMiso, nodeFnMiso);
            var ngThree = new DataDoo.NodeGenerator(dd, "ngThree", dsThree, nodeFnThree);

            var rg = new DataDoo.RelationGenerator(dd, "rg", [ngMiso, ngThree], relFn);

            dsMiso.fetch();
            dsThree.fetch();


            dd.startVis(rg);

        </script>
    </body>
</html>